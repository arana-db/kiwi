# 测试补充实现计划

## 目标
补充三个关键缺失的测试类型，提高测试覆盖率和系统可靠性。

## 任务列表

### 1. WRONGTYPE 错误测试
**文件**: `tests/python/test_wrongtype_errors.py`

**测试用例**:
- [ ] 1.1 测试对列表类型键使用 MSET
- [ ] 1.2 测试对哈希类型键使用 MSET
- [ ] 1.3 测试对集合类型键使用 MSET
- [ ] 1.4 测试对有序集合类型键使用 MSET
- [ ] 1.5 测试 WRONGTYPE 错误格式符合 Redis 协议

**预期结果**: 所有测试应捕获 `redis.ResponseError` 并验证错误消息包含 "WRONGTYPE"

---

### 2. 网络分区测试
**文件**: `tests/raft_network_partition_tests.rs`

**测试用例**:
- [ ] 2.1 测试三节点集群的网络分区场景
  - 启动 3 节点 Raft 集群
  - 模拟 leader 节点网络隔离
  - 验证新 leader 选举成功
  - 恢复网络连接
  - 验证数据一致性

- [ ] 2.2 测试分区期间的写入操作
  - 在分区期间尝试写入
  - 验证少数派节点拒绝写入
  - 验证多数派节点接受写入

- [ ] 2.3 测试分区恢复后的数据同步
  - 分区期间在多数派写入数据
  - 恢复网络
  - 验证少数派节点同步数据

- [ ] 2.4 测试脑裂预防
  - 模拟网络分区导致两个分区
  - 验证只有多数派能选举 leader
  - 验证少数派不能处理写入

**技术要点**:
- 使用 `tokio::time::timeout` 模拟网络延迟
- 使用 channel 控制节点间通信
- 使用临时目录存储测试数据

---

### 3. MSET 并发测试
**文件**: `tests/python/test_mset_concurrent.py`

**测试用例**:
- [ ] 3.1 测试并发 MSET 操作的原子性
  - 10 个线程同时执行 MSET
  - 验证所有操作成功
  - 验证数据完整性

- [ ] 3.2 测试并发 MSET 和 GET 混合操作
  - 5 个线程执行 MSET
  - 5 个线程执行 GET
  - 验证读取的数据一致性

- [ ] 3.3 测试高并发场景（100 线程）
  - 100 个线程并发执行 MSET
  - 验证无数据丢失
  - 验证无数据损坏

- [ ] 3.4 测试并发 MSET 覆盖相同键
  - 多个线程同时 MSET 相同的键
  - 验证最终值是某个线程的完整写入
  - 验证无部分写入

**技术要点**:
- 使用 `concurrent.futures.ThreadPoolExecutor`
- 使用 `threading.Barrier` 同步线程启动
- 验证操作的原子性和一致性

---

## 实现优先级

1. **高优先级**: 网络分区测试（高风险，关键功能）
2. **中优先级**: WRONGTYPE 错误测试（协议兼容性）
3. **中优先级**: MSET 并发测试（数据一致性）

---

## 预期成果

- 新增 3 个测试文件
- 新增约 15-20 个测试用例
- 测试覆盖率从 70% 提升到 85%+
- 降低生产环境风险

---

## 验证标准

所有测试应该：
- ✅ 能够独立运行
- ✅ 有清晰的测试文档
- ✅ 包含失败场景测试
- ✅ 执行时间合理（< 30 秒每个测试）
- ✅ 使用 pytest 框架（Python）或 tokio::test（Rust）
