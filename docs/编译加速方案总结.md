# Kiwi 编译加速方案总结

## 📋 问题描述

每次运行 `cargo build` 或 `cargo run` 都会重新编译 `librocksdb-sys`，耗时约 15-18 分钟，严重影响开发效率。

## ✅ 已实施的解决方案

### 1. 优化 Cargo 配置

**文件：`.cargo/config.toml`**
- 启用增量编译
- 配置并行编译任务数
- 优化构建缓存

**文件：`Cargo.toml`**
- 降低 dev 模式优化级别（opt-level = 0）
- 减少调试信息（debug = 1）
- 启用增量编译

### 2. 创建开发辅助工具

#### 批处理文件（推荐，无需执行策略）
- **dev.cmd** - Windows 批处理版本，直接运行

#### PowerShell 脚本
- **dev.ps1** - 功能完整的开发工具
- **fast_build.ps1** - 快速构建脚本
- **setup_sccache.ps1** - sccache 配置脚本

### 3. 提供详细文档

- **使用说明.txt** - 快速参考
- **QUICK_START.md** - 快速开始指南
- **BUILD_OPTIMIZATION.md** - 详细优化说明

## 🚀 立即使用（推荐方案）

### 方案 A：使用开发脚本（最简单）

**Windows:**
```cmd
# 快速检查（最常用）
scripts\dev check

# 自动监视文件变化
scripts\dev watch

# 构建并运行
scripts\dev run

# 查看统计
scripts\dev stats
```

**Linux/macOS:**
```bash
# 首次使用需要添加执行权限
chmod +x scripts/*.sh

# 快速检查（最常用）
./scripts/dev.sh check

# 自动监视文件变化
./scripts/dev.sh watch

# 构建并运行
./scripts/dev.sh run

# 查看统计
./scripts/dev.sh stats
```

### 方案 B：直接使用 Cargo 命令

```cmd
# 快速检查（推荐开发时使用）
cargo check

# 自动监视
cargo install cargo-watch
cargo watch -x check

# 构建
cargo build

# 运行
cargo run
```

### 方案 C：安装 sccache（最大加速）

```cmd
# 1. 安装 sccache
cargo install sccache

# 2. 配置（编辑 %USERPROFILE%\.cargo\config.toml）
[build]
rustc-wrapper = "sccache"

# 3. 验证
sccache --show-stats

# 4. 之后的编译会自动使用缓存
cargo build
```

## 📊 性能对比

| 方法 | 首次编译 | 增量编译 | 说明 |
|------|---------|---------|------|
| `cargo build` | 18 分钟 | 2-5 分钟 | 完整构建 |
| `cargo check` | 5 分钟 | 10-30 秒 | 只检查，不生成可执行文件 |
| `cargo check`（增量） | - | 5-10 秒 | 修改少量代码后 |
| `cargo build` + sccache | 18 分钟 | 1-2 分钟 | 使用缓存 |
| `cargo build -p server` | 3 分钟 | 10-30 秒 | 只编译单个模块 |

## 💡 最佳实践

### 日常开发工作流

**Windows:**
```cmd
# 终端 1：启动自动监视
scripts\dev watch

# 终端 2：编辑代码
# 保存后自动检查，几秒钟就能看到结果

# 需要运行时
scripts\dev run
```

**Linux/macOS:**
```bash
# 终端 1：启动自动监视
./scripts/dev.sh watch

# 终端 2：编辑代码
# 保存后自动检查，几秒钟就能看到结果

# 需要运行时
./scripts/dev.sh run
```

### 快速验证代码

```bash
# 只检查语法和类型，不生成可执行文件
# Windows:
scripts\dev check
# Linux/macOS:
./scripts/dev.sh check
# 或跨平台:
cargo check
```

### 只编译修改的模块

```cmd
# 如果只修改了 server 模块
cargo build -p server

# 如果修改了多个模块
cargo build -p server -p runtime -p net
```

## 🎯 核心建议

### ✅ 推荐做法

1. **开发时使用 `cargo check`** - 快 5-10 倍
2. **使用 `dev watch` 自动检查** - 保存即检查
3. **安装 sccache** - 缓存编译结果
4. **避免 `cargo clean`** - 除非必要
5. **只编译修改的模块** - 使用 `-p` 参数

### ❌ 避免做法

1. 不要频繁运行 `cargo clean`
2. 不要每次都 `cargo build --release`（开发时）
3. 不要在开发时使用完整的 `cargo build`

## 🔧 故障排除

### 问题：编译仍然很慢

**解决方案：**

1. 确认使用 `cargo check` 而不是 `cargo build`
2. 检查是否启用了增量编译：
   ```cmd
   set CARGO_INCREMENTAL=1
   ```
3. 安装并配置 sccache
4. 检查磁盘空间是否充足

### 问题：sccache 不工作

**解决方案：**

```cmd
# 重启 sccache
sccache --stop-server
sccache --start-server

# 查看统计
sccache --show-stats

# 清理缓存
sccache --zero-stats
```

### 问题：target 目录太大

**解决方案：**

```cmd
# 查看大小
dev stats

# 清理 debug 构建（保留 release）
rmdir /s /q target\debug

# 完全清理
cargo clean
```

## 📈 预期效果

### 使用 cargo check

- **首次检查**：~5 分钟（vs 18 分钟构建）
- **增量检查**：~10-30 秒（vs 2-5 分钟构建）
- **小改动检查**：~5-10 秒

### 使用 sccache

- **首次构建**：正常时间（18 分钟）
- **后续构建**：节省 50-90% 时间
- **librocksdb-sys**：从缓存加载，几乎瞬间完成

### 使用 cargo watch

- **自动检查**：保存后 5-10 秒内完成
- **无需手动运行**：提高开发效率

## 📚 更多资源

- **快速开始**：查看 `QUICK_START.md`
- **详细优化**：查看 `BUILD_OPTIMIZATION.md`
- **使用说明**：查看 `使用说明.txt`

## 🎉 总结

通过以上优化，开发时的编译时间可以从 **18 分钟降低到 10-30 秒**，大幅提升开发效率！

**关键点**：
1. 开发时用 `cargo check` 或 `dev check`
2. 使用 `dev watch` 自动检查
3. 安装 sccache 缓存编译结果
4. 避免不必要的 `cargo clean`

**立即开始**：
```bash
# Windows
scripts\dev check

# Linux/macOS
./scripts/dev.sh check

# 或跨平台
cargo check
```
