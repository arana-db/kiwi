# Openraft 0.9.21 Sealed Traits è§£å†³æ–¹æ¡ˆ

## é—®é¢˜æ€»ç»“

Openraft 0.9.21 ä½¿ç”¨ sealed traits æ¥é™åˆ¶å­˜å‚¨å±‚çš„å®ç°æ–¹å¼ã€‚è¿™æ˜¯ä¸€ä¸ªæœ‰æ„çš„è®¾è®¡å†³ç­–ï¼Œç›®çš„æ˜¯ï¼š
1. å¼ºåˆ¶ä½¿ç”¨ç‰¹å®šçš„ API æ¨¡å¼
2. ä¿æŒå‘åå…¼å®¹æ€§çš„åŒæ—¶å…è®¸å†…éƒ¨é‡æ„
3. å¼•å¯¼ç”¨æˆ·ä½¿ç”¨æ¨èçš„é›†æˆæ–¹å¼

## Sealed Traits åˆ—è¡¨

### å¯ä»¥ç›´æ¥å®ç°ï¼ˆé sealedï¼‰
- âœ… `RaftLogReader<C>` - è¯»å–æ—¥å¿—
- âœ… `RaftSnapshotBuilder<C>` - æ„å»ºå¿«ç…§  
- âœ… `RaftLogWriter<C>` - å†™å…¥æ—¥å¿—ï¼ˆéœ€è¦éªŒè¯ï¼‰

### ä¸èƒ½ç›´æ¥å®ç°ï¼ˆsealedï¼‰
- âŒ `RaftStateMachine<C>` - çŠ¶æ€æœºæ¥å£
- âŒ `RaftLogStorage<C>` - æ—¥å¿—å­˜å‚¨æ¥å£
- âŒ `RaftStorage<C>` - ç»„åˆå­˜å‚¨æ¥å£

## å¯è¡Œçš„è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ Openraft å†…ç½®ç±»å‹ï¼ˆæœ€ç®€å•ï¼‰

Openraft æä¾›äº† `MemStore` ç­‰å†…ç½®å®ç°ï¼š

```rust
use openraft::storage::MemStore;

let store = MemStore::new(node_id);
let (log_store, state_machine) = Adaptor::new(store);
let raft = Raft::new(node_id, config, network, log_store, state_machine);
```

**ä¼˜ç‚¹**ï¼š
- å¼€ç®±å³ç”¨
- ç»è¿‡å……åˆ†æµ‹è¯•
- ç¬¦åˆ Openraft çš„è®¾è®¡æ„å›¾

**ç¼ºç‚¹**ï¼š
- å†…å­˜å­˜å‚¨ï¼Œä¸æŒä¹…åŒ–
- æ— æ³•ä½¿ç”¨ RocksDB
- æ— æ³•è‡ªå®šä¹‰å­˜å‚¨é€»è¾‘

### æ–¹æ¡ˆ 2ï¼šåŒ…è£…å†…ç½®ç±»å‹ï¼ˆæ¨èï¼‰

åœ¨ `MemStore` æˆ–å…¶ä»–å†…ç½®ç±»å‹çš„åŸºç¡€ä¸Šæ·»åŠ æŒä¹…åŒ–å±‚ï¼š

```rust
struct PersistentStore {
    mem_store: MemStore<TypeConfig>,
    rocksdb: Arc<DB>,
}

impl PersistentStore {
    // åœ¨ mem_store æ“ä½œååŒæ­¥åˆ° RocksDB
    async fn sync_to_disk(&self) -> Result<()> {
        // å®ç°æŒä¹…åŒ–é€»è¾‘
    }
}
```

**ä¼˜ç‚¹**ï¼š
- åˆ©ç”¨ Openraft çš„å†…ç½®å®ç°
- æ·»åŠ æŒä¹…åŒ–èƒ½åŠ›
- ç›¸å¯¹ç®€å•

**ç¼ºç‚¹**ï¼š
- åŒé‡å­˜å‚¨å¼€é”€
- åŒæ­¥å¤æ‚æ€§
- æ€§èƒ½å¯èƒ½ä¸æ˜¯æœ€ä¼˜

### æ–¹æ¡ˆ 3ï¼šç ”ç©¶ Openraft æ‰©å±•ç‚¹ï¼ˆéœ€è¦æ·±å…¥ç ”ç©¶ï¼‰

Openraft å¯èƒ½æä¾›äº†æŸç§æ‰©å±•æœºåˆ¶æˆ–å®æ¥å¸®åŠ©å®ç°è‡ªå®šä¹‰å­˜å‚¨ã€‚éœ€è¦ï¼š

1. æŸ¥çœ‹ Openraft çš„å®˜æ–¹ç¤ºä¾‹
2. ç ”ç©¶ `MemStore` çš„å®ç°æºç 
3. æŸ¥æ‰¾æ˜¯å¦æœ‰ derive å®æˆ– helper traits
4. é˜…è¯» Openraft 0.9 çš„è¿ç§»æŒ‡å—

### æ–¹æ¡ˆ 4ï¼šé™çº§åˆ° Openraft 0.8ï¼ˆä¸æ¨èï¼‰

å¦‚æœ 0.8 ç‰ˆæœ¬æ²¡æœ‰ sealed traitsï¼Œå¯ä»¥è€ƒè™‘é™çº§ã€‚

**ä¼˜ç‚¹**ï¼š
- å¯èƒ½æ›´å®¹æ˜“é›†æˆ

**ç¼ºç‚¹**ï¼š
- å¤±å»æ–°åŠŸèƒ½
- å¯èƒ½æœ‰å®‰å…¨æˆ–æ€§èƒ½é—®é¢˜
- ä¸æ˜¯é•¿æœŸè§£å†³æ–¹æ¡ˆ

## æ¨èçš„è¡ŒåŠ¨è®¡åˆ’

### é˜¶æ®µ 1ï¼šæ·±å…¥ç ”ç©¶ï¼ˆ1-2 å¤©ï¼‰

1. **æŸ¥çœ‹ Openraft å®˜æ–¹ç¤ºä¾‹**
   - åœ¨ GitHub ä¸ŠæŸ¥æ‰¾ openraft ä»“åº“
   - æŸ¥çœ‹ examples ç›®å½•
   - ç†è§£æ¨èçš„ä½¿ç”¨æ¨¡å¼

2. **ç ”ç©¶ MemStore æºç **
   - æŸ¥çœ‹ `~/.cargo/registry/src/.../openraft-0.9.21/src/storage/`
   - ç†è§£å†…ç½®å®ç°çš„ç»“æ„
   - æ‰¾åˆ°å¯èƒ½çš„æ‰©å±•ç‚¹

3. **æŸ¥æ‰¾ç¤¾åŒºè§£å†³æ–¹æ¡ˆ**
   - æœç´¢ GitHub issues
   - æŸ¥çœ‹å…¶ä»–é¡¹ç›®å¦‚ä½•é›†æˆ Openraft 0.9
   - å¯»æ‰¾æœ€ä½³å®è·µ

### é˜¶æ®µ 2ï¼šé€‰æ‹©æ–¹æ¡ˆï¼ˆåŠå¤©ï¼‰

åŸºäºç ”ç©¶ç»“æœï¼Œé€‰æ‹©æœ€åˆé€‚çš„æ–¹æ¡ˆï¼š
- å¦‚æœæ‰¾åˆ°æ‰©å±•ç‚¹ â†’ ä½¿ç”¨æ–¹æ¡ˆ 3
- å¦‚æœæ²¡æœ‰æ‰©å±•ç‚¹ â†’ ä½¿ç”¨æ–¹æ¡ˆ 2ï¼ˆåŒ…è£…å†…ç½®ç±»å‹ï¼‰
- å¦‚æœæ–¹æ¡ˆ 2 ä¸å¯è¡Œ â†’ è€ƒè™‘æ–¹æ¡ˆ 4ï¼ˆé™çº§ï¼‰

### é˜¶æ®µ 3ï¼šå®ç°å’Œæµ‹è¯•ï¼ˆ3-5 å¤©ï¼‰

æ ¹æ®é€‰æ‹©çš„æ–¹æ¡ˆå®ç°é›†æˆã€‚

## å½“å‰çŠ¶æ€

- âŒ ä»»åŠ¡ 1 çš„ç ”ç©¶ç»“è®ºé”™è¯¯ï¼Œå·²æ›´æ­£
- â¸ï¸ ä»»åŠ¡ 2 æš‚åœï¼Œç­‰å¾…æ–°æ–¹æ¡ˆ
- ğŸ“‹ éœ€è¦é‡æ–°è§„åˆ’æ‰€æœ‰åç»­ä»»åŠ¡

## å…³é”®æ•™è®­

1. **å¿…é¡»é€šè¿‡ç¼–è¯‘éªŒè¯å‡è®¾**
   - ä¸èƒ½ä»…ä¾èµ–æ–‡æ¡£
   - Rust çš„ç±»å‹ç³»ç»Ÿå¾ˆä¸¥æ ¼

2. **Sealed traits æ˜¯æœ‰æ„çš„è®¾è®¡**
   - ä¸æ˜¯ bugï¼Œæ˜¯ feature
   - éœ€è¦ç†è§£åº“ä½œè€…çš„æ„å›¾

3. **çµæ´»è°ƒæ•´è®¡åˆ’**
   - å½“å‘ç°é”™è¯¯æ—¶ï¼ŒåŠæ—¶åœæ­¢
   - é‡æ–°è¯„ä¼°è€Œä¸æ˜¯ç¡¬æ¨è¿›

## å‚è€ƒèµ„æ–™

- [Openraft GitHub](https://github.com/datafuselabs/openraft)
- [Openraft æ–‡æ¡£](https://docs.rs/openraft/0.9.21/)
- [Rust Sealed Trait æ¨¡å¼](https://rust-lang.github.io/api-guidelines/future-proofing.html#sealed-traits-protect-against-downstream-implementations-c-sealed)
